{% extends('base.html.twig') %}

{% block content %}

    {% block wiki %}
        {% if discussion.wikis | length > 0 %}
            <div class="wiki_block"><table border="0" width="100%"><tr><td align="center">Deze forumdiscussie is gekoppeld aan de <a href="http://www.railwiki.nl/" target="_blank">RailWiki.nl</a> pagina('s):<br />
            {% for wiki in discussion.wikis %}
                <a href="http://www.railwiki.nl/index.php/{{ wiki.wiki }}" target="_blank">{{ wiki.title }}</a>
                {% if not loop.last %} - {% endif %}
            {% endfor %}
            </td>
            <td><a href="http://www.railwiki.nl/" target="_blank"><img alt="RailWiki.nl" height="110" src="{{ asset('images/railwiki-logo.png') }}" width="296" /></a></td></tr></table></div>
        {% endif %}
    {% endblock %}

    <div class="moduleS1" style="margin-bottom:0;"><div>
        {% if userIsModerator %}
            <span id="mod_icons">
                <a href="/index.php?blokid=40&amp;op=lockdisc&amp;forum_discussionid={{ discussion.id }}"><img alt="Sluit/open discussie"src="{{ asset('images/forum/disc_' ~ (discussion.locked ? 'unlock' : 'lock') ~ '.gif') }}" /></a>
                <a href="/index.php?blokid=40&amp;op=movedisc&amp;forum_discussionid={{ discussion.id }}"><img alt="Verplaats discussie" src="{{ asset('images/forum/disc_move.gif') }}" /></a>
                <a href="/index.php?blokid=40&amp;op=combinedisc&amp;forum_discussionid={{ discussion.id }}"><img alt="Combineer met andere discussie" src="{{ asset('images/forum/disc_combine.gif') }}" /></a>
            </span>
         {% endif %}
        {% if is_granted('IS_AUTHENTICATED_REMEMBERED') %}
            <span id="favorite_box"><span id="favorite">
                {% if app.user and app.user.forumFavorite(discussion) %}
                    <a href="#" onclick="fav_del(); return false;">Verwijder discussie</a> uit je <a href="/favorieten/">favorieten</a>
                {% else %}
                    <a href="#" onclick="fav_add(); return false;">Voeg discussie toe</a> aan je <a href="/favorieten/">favorieten</a>
                {% endif %}
            </span></span>
        {% endif %}
        <h3 id="disc_title">
            <img alt="" border="0" src="{{ asset('images/forum/folder_' ~ (discussion.locked ? 'l' : 'u') ~ 'br.gif') }}" />
            {% if discussion.type == 1 %}<img height="16" src="{{ asset('images/forum/sticky.gif') }}" width="16" />{% endif %}
            {% if discussion.type == 1 %}<img height="24" src="{{ asset('images/forum/announcement.png') }}" width="28" /> Mededeling: {% endif %}
            {{ discussion.title }}
        </h3>
    </div></div>

    {% block paginator %}
        {% if numberOfPages > 1 %}
            <ul class="pagination">
                {% if pageNumber > 1 %}<li><a href="{{ path('forum_discussion_page', { 'id': discussion.id, 'name': (discussion.title | url_encode), 'pageNumber': (pageNumber - 1) }) }}">«</a></li>{% endif %}
                {% for page in 1..numberOfPages %}
                    <li><span>
                        {% if page != pageNumber %}<a href="{{ path('forum_discussion_page', { 'id': discussion.id, 'name': (discussion.title | url_encode), 'pageNumber': page }) }}">{{ page }}</a>{% else %}{{ page }}{% endif %}
                    </span></li>
                {% endfor %}
                {% if pageNumber < numberOfPages %}<li><a href="{{ path('forum_discussion_page', { 'id': discussion.id, 'name': (discussion.title | url_encode), 'pageNumber': (pageNumber + 1) }) }}">»</a></li>{% endif %}
            </ul>
        {% endif %}
    {% endblock %}

    <p style="margin-left:10px;">
        {% if userIsModerator %}
            <input name="op" type="hidden" value="" /><input name="forum_discussionid" type="hidden" value="', $forum_discussionid, '" />
            Met geselecteerd: <a href="#" onclick="document.MasterForm.op.value='sel_new'; document.MasterForm.submit(); return false;"><img alt="Splits af naar een nieuwe discussie" src="{{ asset('images/forum/folder_usr.gif') }}" title="Splits af naar een nieuwe discussie" /></a>
            <a style="float:right; margin-right:5px" href="#" onclick="document.MasterForm.op.value='sel_del'; document.MasterForm.submit(); return false;"><img alt="Verwijder direct" src="{{ asset('images/forum/disc_delete.gif') }}" title="Verwijder direct" /></a>
        {% endif %}
        {% if is_granted('ROLE_ADMIN_WIKI') %}
            <a href="#" onclick="getElementById('wiki_add').style.visibility = 'visible'; return false;"><img alt="Voeg een RailWiki link toe" src="{{ asset('images/plus.png') }}" /> Voeg een RailWiki link toe</a>
            <span id="wiki_add" style="visibility:hidden;">
                <br />Plak de gehele URL van de wiki pagina: <input id="wiki_page_add" name="wiki_page_add" size="50" type="text" />
                <br />Titel van de wiki pagina: <input id="wiki_page_title" name="wiki_page_title" size="50" type="text" />&nbsp;<a href="#" onclick="wikiadd();">Voeg verwijzing toe</a>
            </span>
        {% endif %}
        {% if userIsModerator or is_granted('ROLE_ADMIN_WIKI') %}<br />{% endif %}
    </p>

    {% set firstUnreadAnchorDone = false %}
    {% for post in posts %}
        {% set postIsUnread = loop.index > (constant('App\\Controller\\ForumBaseController::MAX_POSTS_PER_PAGE') * (pageNumber - 1) + numberOfReadPosts) %}
        {% if loop.index == 5 or loop.index == 55 %}
            {% if forumBanner is not null %}
                <br /><table align="center" class="design" width="98%"><tr>
                    <td><a href="/click_out.php?banner_id={{ forumBanner.id }}" target="_blank">
                        <img alt="{{ forumBanner.customer.name }} {{ forumBanner.description }}" height="150" src="{{ asset('images/banners/' ~ forumBanner.image) }}" />
                    </a></td>
                    <td><a href="/adverteren/">advertentie</a></td>
                </tr></table><br />
            {% else %}
                <br /><table align="center" class="design" width="98%"><tr>
                    <td><p class="warn">Tevreden over Somda? Overweeg dan eens een <a href="/doneren/">vrijwillige donatie</a>, alvast bedankt!</p></td>
                </tr></table><br />
            {% endif %}
        {% endif %}

        <table align="center" class="design" width="98%">
            <tr>
                <th colspan="{{ is_granted('IS_AUTHENTICATED_REMEMBERED') ? 2 : 3 }}" style="text-align:left;">
                    {% if userIsModerator %}<input name="sel{{ post.id }}" type="checkbox" />{% endif %}
                    <a id="p{{ post.id }}" name="p{{ post.id }}"></a>
                    {% if postIsUnread and not firstUnreadAnchorDone %}
                        <a id="nieuw" name="nieuw"></a>
                        {% set firstUnreadAnchorDone = true %}
                    {% endif %}
                    <a href="{{ path('forum_discussion_post', { 'id': discussion.id, 'name': (discussion.title | url_encode), 'postId': post.id }) }}">
                        <img src="{{ asset('images/forum/folder_' ~ (discussion.locked ? 'l' : 'u') ~ 's' ~ (postIsUnread ? 'n' : 'r') ~ '.gif') }}" />
                    </a>{{ post.timestamp | date('d-m-Y H:i:s') }}
                </th>
                {% if is_granted('IS_AUTHENTICATED_REMEMBERED') %}
                    <th>
                        <a href="/forum/meld/p{{ post.id }}/" rel="nofollow" title="Klik hier om dit bericht aan de beheerders te melden. Gebruik dit voor bijvoorbeeld overtredingen van forumregels"><font color="#FFFFFF">Meld bericht</font></a>
                        {% if userIsModerator and (post.alerts | length) > 0 %}
                            <br /><a href="/forum/meldingen/p{{ post.id }}/" rel="nofollow" title="Er zijn meldingen gedaan over dit bericht, klik om ze te bekijken"><font color="#DD1111">Meldingen</font></a>
                        {% endif %}
                    </th>
                {% endif %}
            </tr><tr>
                <td class="info" nowrap="nowrap">
                    {{ post.author.id | displayUser(post.author.username) | raw }}
                    {% if userIsModerator %}
                        <br /><strong>Moderator</strong>
                    {% endif %}
                    {% if userIsModerator and post.author.info.company is not null %}
                        <br /><strong>-- {{ post.author.info.company.name }} --</strong>
                    {% endif %}
                    {% if post.author.info.avatar | length > 0 %}
                        <br /><img alt="{{ post.author.username }}" src="{{ asset('images/avatar/' ~  post.author.info.avatar) }}" />
                    {% endif %}
                    {% if post.author.info.city | length > 0 and is_granted('IS_AUTHENTICATED_REMEMBERED') %}
                        <br />{{ post.author.info.city }}
                    {% endif %}
                    <br />
                    {% if post.author.info.twitterAccount | length > 0 %}
                        <a href="https://twitter.com/#!/{{ post.author.info.twitterAccount }}" target="_blank"><img alt="Twitter {{ post.author.info.twitterAccount }}" height="16" src="{{ asset('images/social-media/twitter.png') }}" width="16" /></a>
                    {% endif %}
                    {% if post.author.info.facebookAccount | length > 0 %}
                        <a href="https://www.facebook.com/{{ post.author.info.facebookAccount }}" target="_blank"><img alt="Facebook {{ post.author.info.facebookAccount }}" height="16" src="{{ asset('images/social-media/facebook.png') }}" width="16" /></a>
                    {% endif %}
                    {% if post.author.info.youtubeAccount | length > 0 %}
                        <a href="https://www.youtube.com/user/{{ post.author.info.youtubeAccount }}" target="_blank"><img alt="Youtube {{ post.author.info.youtubeAccount }}" height="16" src="{{ asset('images/social-media/youtube.png') }}" width="16" /></a>
                    {% endif %}
                    {% if post.author.info.flickrAccount | length > 0 %}
                        <a href="https://www.flickr.com/photos/{{ post.author.info.flickrAccount }}" target="_blank"><img alt="Flickr {{ post.author.info.flickrAccount }}" height="16" src="{{ asset('images/social-media/flickr.png') }}" width="37" /></a>
                    {% endif %}
                </td>
                <td class="text">{{ post | displayForumPost | raw }}</td>
                <td class="buttons"><table>
                    {% if mayPost and not discussion.locked %}
                        <tr><td style="border:none;"><div class="button_clear"><div class="somda-button-left"><div class="blank_home"><a href="{{ path('forum_discussion_post_reply', { 'id': post.id }) }}"><span>Reageer</span></a></div></div></div></td></tr>
                    {% endif %}
                    {% if userIsModerator or (mayPost and not discussion.locked and post.author == app.user) %}
                        <tr><td style="border:none;"><div class="button_clear"><div class="somda-button-left"><div class="blank_home"><a href="/bewerken"><span>Bewerk</span></a></div></div></div>
                    {% endif %}
                </table></td>
            </tr>
            {% if is_granted('ROLE_ADMIN_WIKI') and discussion.wikis | length > 0 %}
                <tr><td colspan="3">Railwiki.nl:
                    {% if post.wikiCheck == 0 %}
                        <span id="wiki_{{ post.id }}" style="background-color:orange">Nog te controleren - <a href="#" onclick="wikicheck({{ post.id }}, 'ok'); return false;">Markeer als gecontroleerd</a> - <a href="#" onclick="wikicheck({{ post.id }}, 'na'); return false;">Markeer als niet relevante inhoud</a></span>
                    {% elseif post.wikiCheck == 1 %}
                        Verwerkt in de wiki door {{ post.wikiChecker | displayUser }}
                    {% else %}
                        Geen relevante inhoud, gecontroleerd door {{ post.wikiChecker | displayUser }}
                    {% endif %}
                </td></tr>
            {% endif %}
        </table>
        <br />
    {% endfor %}

    {{ block('wiki') }}

    {{ block('paginator') }}

{% endblock %}

{% block javascript %}
    {% if is_granted('ROLE_ADMIN_WIKI') %}
        <script type="text/javascript">
            function wikiadd() {
                makeRequest('/blocks/ajax/forum_wiki.php?op=add&discid={{ discussion.id }}&title=' + document.getElementById('wiki_page_title').value + '&page=' + document.getElementById('wiki_page_add').value);
                document.getElementById('wiki_add').innerHTML = '<br />Dank voor je toevoeging, ververs de pagina om je wijziging te zien';
            }
            function wikicheck(postid, op) {
                makeRequest('/blocks/ajax/forum_wiki.php?op=' + op + '&postid=' + postid);
                document.getElementById('wiki_' + postid).innerHTML = '<img alt="" border="0" height="15" src="/vinkje.jpg" width="15" /></a>';
            }
        </script>
    {% endif %}

    <script type="text/javascript">
        function fav_add() {
            makeRequest('/blocks/ajax/forum_fav.php?op=add&discid={{ discussion.id }}');
            document.getElementById('favorite').innerHTML = 'Discussie is in je <a href="/favorieten/">favoriete discussies</a> geplaatst.';
        }
        function fav_del() {
            makeRequest('/blocks/ajax/forum_fav.php?op=del&discid={{ discussion.id }}');
            document.getElementById('favorite').innerHTML = 'Discussie is uit je <a href="/favorieten/">favoriete discussies</a> verwijderd.';
        }
    </script>
{% endblock %}
